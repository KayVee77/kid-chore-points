name: Deploy ChorePoints

on:
   push:
      branches: ["**"]  # Trigger on ALL branches for testing
   pull_request:
      branches: ["main"]
   workflow_dispatch:

env:
   PYTHON_VERSION: "3.11"
   DJANGO_SETTINGS_MODULE: "chorepoints.settings"

jobs:
   build-and-deploy:
      runs-on: ubuntu-latest

      steps:
         - name: Checkout source
           uses: actions/checkout@v4

         - name: Set up Python ${{ env.PYTHON_VERSION }}
           uses: actions/setup-python@v5
           with:
              python-version: ${{ env.PYTHON_VERSION }}

         - name: Install dependencies
           working-directory: chorepoints
           run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt

         - name: Run unit tests (placeholder)
           working-directory: chorepoints
           run: |
              pip install pytest pytest-django
              # pytest core/tests  # Enable once tests are added
           continue-on-error: true

         - name: Create deployment archive
           working-directory: chorepoints
           run: |
              rm -f ../chorepoints.zip
              zip -r ../chorepoints.zip . \
                 -x "*.git*" \
                 -x "*.pyc" \
                 -x "*/__pycache__/*" \
                 -x "*/.pytest_cache/*" \
                 -x "*/.mypy_cache/*" \
                 -x ".venv/*" \
                 -x "env/*" \
                 -x "venv/*"

         - name: Azure login
           uses: azure/login@v2
           with:
              creds: ${{ secrets.AZURE_CREDENTIALS }}

         - name: Deploy via Azure CLI
           run: |
              echo "Deploying to Azure App Service..."
              az webapp deployment source config-zip \
                --resource-group chorepoints-rg-us \
                --name elija-agota \
                --src ./chorepoints.zip \
                --verbose
              
              echo "✓ Deployment completed successfully"

         - name: Restart Azure Web App
           run: |
              echo "Restarting web app to load new code..."
              az webapp restart --name elija-agota --resource-group chorepoints-rg-us
              echo "Waiting 30 seconds for app to restart..."
              sleep 30

         - name: Verify deployment
           run: |
              echo "Checking health endpoint..."
              RESPONSE=$(curl -s https://elija-agota.azurewebsites.net/kid/health-check/ || echo "FAILED")
              echo "Response: $RESPONSE"
              
              if echo "$RESPONSE" | grep -q "2025.11.20-deployment-test"; then
                echo "✓ Deployment verified successfully!"
              else
                echo "⚠ Warning: Could not verify deployment version"
                echo "Expected version: 2025.11.20-deployment-test"
              fi

         - name: Logout
           if: always()
           run: az logout
