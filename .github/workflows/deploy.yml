name: Deploy ChorePoints

on:
   push:
      branches: ["**"]  # Trigger on ALL branches for testing
   pull_request:
      branches: ["main"]
   workflow_dispatch:

env:
   PYTHON_VERSION: "3.11"
   DJANGO_SETTINGS_MODULE: "chorepoints.settings"

jobs:
   build-and-deploy:
      runs-on: ubuntu-latest

      steps:
         - name: Checkout source
           uses: actions/checkout@v4

         - name: Set up Python ${{ env.PYTHON_VERSION }}
           uses: actions/setup-python@v5
           with:
              python-version: ${{ env.PYTHON_VERSION }}

         - name: Install dependencies
           working-directory: chorepoints
           run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt

         - name: Run unit tests (placeholder)
           working-directory: chorepoints
           run: |
              pip install pytest pytest-django
              # pytest core/tests  # Enable once tests are added
           continue-on-error: true

         - name: Create deployment archive
           working-directory: chorepoints
           run: |
              rm -f ../chorepoints.zip
              zip -r ../chorepoints.zip . \
                 -x "*.git*" \
                 -x "*.pyc" \
                 -x "*/__pycache__/*" \
                 -x "*/.pytest_cache/*" \
                 -x "*/.mypy_cache/*" \
                 -x ".venv/*" \
                 -x "env/*" \
                 -x "venv/*"

         - name: Azure login
           uses: azure/login@v2
           with:
              creds: ${{ secrets.AZURE_CREDENTIALS }}

         - name: Get Publishing Credentials
           id: publish-creds
           run: |
              # Get all publishing profiles to debug
              echo "Fetching publishing profiles..."
              PROFILES=$(az webapp deployment list-publishing-profiles \
                --name elija-agota \
                --resource-group chorepoints-rg-us \
                -o json)
              
              echo "Available publish methods:"
              echo "$PROFILES" | jq -r '.[].publishMethod'
              
              # Try ZipDeploy first (case-sensitive)
              CREDS=$(echo "$PROFILES" | jq '[.[] | select(.publishMethod=="ZipDeploy")][0] | {user:.userName, pass:.userPWD}')
              
              # If not found, try case-insensitive or MSDeploy as fallback
              if [ "$CREDS" == "null" ] || [ -z "$CREDS" ]; then
                echo "ZipDeploy not found, trying alternative methods..."
                CREDS=$(echo "$PROFILES" | jq '[.[] | select(.publishMethod | ascii_downcase == "zipdeploy")][0] | {user:.userName, pass:.userPWD}')
              fi
              
              if [ "$CREDS" == "null" ] || [ -z "$CREDS" ]; then
                echo "No ZipDeploy credentials found, using first available profile..."
                CREDS=$(echo "$PROFILES" | jq '.[0] | {user:.userName, pass:.userPWD}')
              fi
              
              USERNAME=$(echo $CREDS | jq -r '.user')
              PASSWORD=$(echo $CREDS | jq -r '.pass')
              
              echo "::add-mask::$PASSWORD"
              echo "username=$USERNAME" >> $GITHUB_OUTPUT
              echo "password=$PASSWORD" >> $GITHUB_OUTPUT
              
              if [ -z "$USERNAME" ] || [ "$USERNAME" == "null" ]; then
                echo "ERROR: Failed to extract credentials!"
                exit 1
              fi

         - name: Deploy via Kudu ZIP API
           run: |
              echo "Deploying to Azure via Kudu ZIP Deploy..."
              echo "Username: ${{ steps.publish-creds.outputs.username }}"
              echo "Endpoint: https://elija-agota.scm.azurewebsites.net/api/zipdeploy"
              
              RESPONSE=$(curl -X POST \
                -u "${{ steps.publish-creds.outputs.username }}:${{ steps.publish-creds.outputs.password }}" \
                --data-binary @"./chorepoints.zip" \
                -H "Content-Type: application/zip" \
                https://elija-agota.scm.azurewebsites.net/api/zipdeploy \
                -w "\n###HTTP_STATUS:%{http_code}###\n" \
                -s)
              
              echo "$RESPONSE"
              
              HTTP_CODE=$(echo "$RESPONSE" | grep -o "###HTTP_STATUS:[0-9]*###" | grep -o "[0-9]*")
              echo "HTTP Status Code: $HTTP_CODE"
              
              if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "202" ]; then
                echo "❌ Deployment failed with status $HTTP_CODE"
                echo "Response body:"
                echo "$RESPONSE" | sed '/###HTTP_STATUS:/d'
                exit 1
              fi
              
              echo "✓ Deployment succeeded with status $HTTP_CODE"

         - name: Restart Azure Web App
           run: |
              echo "Restarting web app to load new code..."
              az webapp restart --name elija-agota --resource-group chorepoints-rg-us
              echo "Waiting 30 seconds for app to restart..."
              sleep 30

         - name: Verify deployment
           run: |
              echo "Checking health endpoint..."
              RESPONSE=$(curl -s https://elija-agota.azurewebsites.net/kid/health-check/ || echo "FAILED")
              echo "Response: $RESPONSE"
              
              if echo "$RESPONSE" | grep -q "2025.11.20-deployment-test"; then
                echo "✓ Deployment verified successfully!"
              else
                echo "⚠ Warning: Could not verify deployment version"
                echo "Expected version: 2025.11.20-deployment-test"
              fi

         - name: Logout
           if: always()
           run: az logout
