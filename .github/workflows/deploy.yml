name: Deploy ChorePoints

on:
   push:
      branches: ["main"]
   workflow_dispatch:

env:
   PYTHON_VERSION: "3.11"
   AZURE_WEBAPP_NAME: elija-agota

jobs:
   build-and-deploy:
      runs-on: ubuntu-latest

      steps:
         - name: Checkout source
           uses: actions/checkout@v4

         - name: Set up Python ${{ env.PYTHON_VERSION }}
           uses: actions/setup-python@v5
           with:
              python-version: ${{ env.PYTHON_VERSION }}

         - name: Create deployment package
           run: |
              cd chorepoints
              zip -r ../app.zip . -x "*.pyc" "*__pycache__*" "*.pytest_cache*" ".git*" "db.sqlite3" "media/*"

         - name: Azure Login
           uses: azure/login@v1
           with:
              creds: ${{ secrets.AZURE_CREDENTIALS }}

         - name: Deploy to Azure Web App
           uses: azure/webapps-deploy@v2
           with:
              app-name: ${{ env.AZURE_WEBAPP_NAME }}
              package: ./app.zip

         - name: Azure Logout
           if: always()
           run: |
              az logout
