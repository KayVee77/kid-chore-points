name: Deploy ChorePoints

on:
   push:
      branches: ["main"]
   pull_request:
      branches: ["main"]
   workflow_dispatch:

env:
   PYTHON_VERSION: "3.11"
   DJANGO_SETTINGS_MODULE: "chorepoints.settings"

jobs:
   build-and-deploy:
      runs-on: ubuntu-latest

      steps:
         - name: Checkout source
           uses: actions/checkout@v4

         - name: Set up Python ${{ env.PYTHON_VERSION }}
           uses: actions/setup-python@v5
           with:
              python-version: ${{ env.PYTHON_VERSION }}

         - name: Install dependencies
           working-directory: chorepoints
           run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt

         - name: Run unit tests (placeholder)
           working-directory: chorepoints
           run: |
              pip install pytest pytest-django
              # pytest core/tests  # Enable once tests are added
           continue-on-error: true

         - name: Create deployment archive
           working-directory: chorepoints
           run: |
              rm -f ../chorepoints.zip
              zip -r ../chorepoints.zip . \
                 -x "*.git*" \
                 -x "*.pyc" \
                 -x "*/__pycache__/*" \
                 -x "*/.pytest_cache/*" \
                 -x "*/.mypy_cache/*" \
                 -x ".venv/*" \
                 -x "env/*" \
                 -x "venv/*"

         - name: Azure login
           uses: azure/login@v2
           with:
              creds: ${{ secrets.AZURE_CREDENTIALS }}

         - name: Deploy to Azure Web App
           uses: azure/webapps-deploy@v3
           with:
              app-name: elija-agota
              package: ./chorepoints.zip
              clean: true
              slot-name: Production
              startup-command: "bash startup.sh"

         - name: Verify deployment
           run: |
              echo "Waiting 30 seconds for deployment to complete..."
              sleep 30
              echo "Checking health endpoint..."
              curl -f https://elija-agota.azurewebsites.net/kid/health-check/ || echo "Health check failed"

         - name: Restart Azure Web App
           run: |
              echo "Restarting web app to ensure new code is loaded..."
              az webapp restart --name elija-agota --resource-group chorepoints-rg-us

         - name: Logout
           if: always()
           run: az logout
