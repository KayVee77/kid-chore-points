name: Deploy ChorePoints

on:
   push:
      branches: ["main"]
   pull_request:
      branches: ["main"]
   workflow_dispatch:

env:
   PYTHON_VERSION: "3.11"
   DJANGO_SETTINGS_MODULE: "chorepoints.settings"

jobs:
   build-and-deploy:
      runs-on: ubuntu-latest

      steps:
         - name: Checkout source
           uses: actions/checkout@v4

         - name: Set up Python ${{ env.PYTHON_VERSION }}
           uses: actions/setup-python@v5
           with:
              python-version: ${{ env.PYTHON_VERSION }}

         - name: Install dependencies
           working-directory: chorepoints
           run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt

         - name: Run unit tests (placeholder)
           working-directory: chorepoints
           run: |
              pip install pytest pytest-django
              # pytest core/tests  # Enable once tests are added
           continue-on-error: true

         - name: Create deployment archive
           working-directory: chorepoints
           run: |
              rm -f ../chorepoints.zip
              zip -r ../chorepoints.zip . \
                 -x "*.git*" \
                 -x "*.pyc" \
                 -x "*/__pycache__/*" \
                 -x "*/.pytest_cache/*" \
                 -x "*/.mypy_cache/*" \
                 -x ".venv/*" \
                 -x "env/*" \
                 -x "venv/*"

         - name: Azure login
           uses: azure/login@v2
           with:
              creds: ${{ secrets.AZURE_CREDENTIALS }}

         - name: Get Publishing Credentials
           id: publish-creds
           run: |
              CREDS=$(az webapp deployment list-publishing-profiles \
                --name elija-agota \
                --resource-group chorepoints-rg-us \
                --query "[?publishMethod=='MSDeploy']|[0].{user:userName,pass:userPWD}" \
                -o json)
              
              USERNAME=$(echo $CREDS | jq -r '.user')
              PASSWORD=$(echo $CREDS | jq -r '.pass')
              
              echo "::add-mask::$PASSWORD"
              echo "username=$USERNAME" >> $GITHUB_OUTPUT
              echo "password=$PASSWORD" >> $GITHUB_OUTPUT

         - name: Deploy via Kudu ZIP API
           run: |
              echo "Deploying to Azure via Kudu ZIP Deploy..."
              curl -X POST \
                -u "${{ steps.publish-creds.outputs.username }}:${{ steps.publish-creds.outputs.password }}" \
                --data-binary @"./chorepoints.zip" \
                -H "Content-Type: application/zip" \
                https://elija-agota.scm.azurewebsites.net/api/zipdeploy \
                -w "\nHTTP Status: %{http_code}\n" \
                --fail-with-body || (echo "Deployment failed!" && exit 1)

         - name: Restart Azure Web App
           run: |
              echo "Restarting web app to load new code..."
              az webapp restart --name elija-agota --resource-group chorepoints-rg-us
              echo "Waiting 30 seconds for app to restart..."
              sleep 30

         - name: Verify deployment
           run: |
              echo "Checking health endpoint..."
              RESPONSE=$(curl -s https://elija-agota.azurewebsites.net/kid/health-check/ || echo "FAILED")
              echo "Response: $RESPONSE"
              
              if echo "$RESPONSE" | grep -q "2025.11.20-deployment-test"; then
                echo "✓ Deployment verified successfully!"
              else
                echo "⚠ Warning: Could not verify deployment version"
                echo "Expected version: 2025.11.20-deployment-test"
              fi

         - name: Logout
           if: always()
           run: az logout
