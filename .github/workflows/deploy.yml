name: Deploy ChorePoints

on:
   push:
      branches: ["main"]
   pull_request:
      branches: ["main"]
   workflow_dispatch:

env:
   PYTHON_VERSION: "3.11"
   DJANGO_SETTINGS_MODULE: "chorepoints.settings"

jobs:
   build-and-deploy:
      runs-on: ubuntu-latest

      steps:
         - name: Checkout source
           uses: actions/checkout@v4

         - name: Set up Python ${{ env.PYTHON_VERSION }}
           uses: actions/setup-python@v5
           with:
              python-version: ${{ env.PYTHON_VERSION }}

         - name: Install dependencies
           working-directory: chorepoints
           run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt

         - name: Run unit tests (placeholder)
           working-directory: chorepoints
           run: |
              pip install pytest pytest-django
              # pytest core/tests  # Enable once tests are added
           continue-on-error: true

         - name: Collect static files
           working-directory: chorepoints
           run: python manage.py collectstatic --noinput

         - name: Archive application
           run: |
              cd chorepoints
              zip -r ../chorepoints-package.zip . -x "__pycache__/*" "*.pyc" "*.pyo" "*.pytest_cache/*"

         - name: Azure login
           uses: azure/login@v2
           with:
              creds: ${{ secrets.AZURE_CREDENTIALS }}

         - name: Deploy to Azure Web App
           uses: azure/webapps-deploy@v3
           with:
              app-name: ${{ vars.AZURE_WEBAPP_NAME }}
              package: chorepoints-package.zip
              slot-name: Production
              startup-command: "bash startup.sh"

         - name: Logout
           if: always()
           run: az logout
